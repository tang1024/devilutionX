<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Devilution: Contribution Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Devilution
   </div>
   <div id="projectbrief">Diablo devolved - magic behind the 1996 computer game</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Contribution Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This guide outlines useful resources, tools and processes for contribution to Devilution.</p>
<h1><a class="anchor" id="autotoc_md118"></a>
Code style guide</h1>
<p><a href="https://github.com/diasurgical/devilution/wiki/Code-Style">The code style guide</a> is evolving with the project.</p>
<h1><a class="anchor" id="autotoc_md119"></a>
Useful Repos</h1>
<ul>
<li><a href="https://github.com/diasurgical/scalpel">diasurgical/scalpel</a> - uploaded .SYM files from each release of Diablo 1 on Playstation</li>
<li><a href="https://github.com/diasurgical/devilution-comparer">diasurgical/devilution-comparer</a> - small helper tool to aid comparing functions between devilution and the original binary</li>
<li><a href="https://github.com/sanctuary/notes">sanctuary/notes</a> - documented Windows-specific Diablo code</li>
<li><a href="https://github.com/sanctuary/psx">sanctuary/psx</a> - .SYM files converted to C headers</li>
</ul>
<h1><a class="anchor" id="autotoc_md120"></a>
Software and Utils</h1>
<ul>
<li>A clean installation of Diablo patched to version 1.09b (Diablo.exe)</li>
<li>Download IDA (Interactive Disassembler) <a href="https://www.hex-rays.com/products/ida/support/download_freeware.shtml">Hex-Rays</a></li>
<li>Download IDC script from sanctuary/notes repository: <a href="http://sanctuary.github.io/notes/notes.idc">notes.idc</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md121"></a>
How To...</h1>
<p>Described below are steps for using the IDA and SYM files to reverse the Diablo source.</p>
<h2><a class="anchor" id="autotoc_md122"></a>
Understanding Devilution and Sanctuary Notes</h2>
<p>Both Devilution and the Sanctuary Notes repo have the intended aim to get as close as possible to document the original game. Devilution is closer in the sense that the same names have been used for functions as based on the SYM debug info. The notes repo has tried to use consistent naming for functions, e.g. prefix with source file name.</p>
<p>See for instance <a href="http://sanctuary.github.io/notes/#function/drlg_l1_load_dun">drlg_l1_load_dun</a>, which is defined in <code><a class="el" href="drlg__l1_8cpp.html">drlg_l1.cpp</a></code>. This function has the PSX signature <code>void LoadL1Dungeon__FPcii(char *sFileName, int vx, int vy)</code>, but is documented in the Sanctuary Notes repo as follows for consistency:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> __fastcall drlg_l1_load_dun(<span class="keywordtype">char</span> *dun_path, <span class="keywordtype">int</span> view_x, <span class="keywordtype">int</span> view_y);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md123"></a>
Interactive Disassembler Usage</h2>
<ul>
<li>Open the <code>Diablo.exe</code> (version 1.09b in IDA) and wait for it to finish analysis<ul>
<li>Open as "Portable Executable"</li>
<li>Processor type i386 (80386)</li>
</ul>
</li>
<li>Run the IDC script in IDA on the fresh IDB database to import names for variables and functions, type definitions, etc. (Note: run the IDC script <b>only</b> on new IDB databases as it removes all variable names before adding new ones.); for more info, see <a href="https://github.com/diasurgical/devilution/pull/79#issuecomment-400536087">#79 (comment)</a></li>
<li>Example: search for <code>drlg_l1_load_dun</code><ul>
<li>Starting memory address <code>0x40AE79</code></li>
<li>Function name <code>drlg_l1_load_dun</code></li>
<li>Function arguments <code>(char *dun_path, int view_x, int view_y)</code></li>
<li>#TODO what else can be inferred from below?</li>
</ul>
</li>
</ul>
<div class="fragment"><div class="line">; drlg_l1_load_dun loads tile IDs, monsters and objects from the given</div>
<div class="line">; dungeon file.</div>
<div class="line">; Attributes: bp-based frame</div>
<div class="line"> </div>
<div class="line">; void __fastcall drlg_l1_load_dun(char *dun_path, int view_x, int view_y)</div>
<div class="line">drlg_l1_load_dun proc near</div>
<div class="line"> </div>
<div class="line">var_C= dword ptr -0Ch</div>
<div class="line">var_8= dword ptr -8</div>
<div class="line">var_4= dword ptr -4</div>
<div class="line">view_y= dword ptr  8</div>
<div class="line"> </div>
<div class="line">push    ebp</div>
<div class="line">mov     ebp, esp</div>
<div class="line">sub     esp, 0Ch</div>
<div class="line">push    ebx</div>
<div class="line">push    esi</div>
<div class="line">push    edi</div>
<div class="line">push    10h</div>
<div class="line">pop     eax</div>
<div class="line">mov     [ebp+var_C], edx</div>
<div class="line">push    60h</div>
<div class="line">mov     dword_5D2458, eax</div>
<div class="line">mov     dword_5D245C, eax</div>
<div class="line">pop     eax</div>
<div class="line">mov     esi, ecx</div>
<div class="line">mov     dword_5CF328, eax</div>
<div class="line">mov     dword_5CF32C, eax</div>
<div class="line">call    gendung_init_transparency</div>
<div class="line">xor     edx, edx        ; size</div>
<div class="line">mov     ecx, esi        ; file_path</div>
<div class="line">call    engine_mem_load_file</div>
<div class="line">mov     esi, eax</div>
<div class="line">xor     ecx, ecx</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md124"></a>
About the SYM</h2>
<p>The <a href="https://github.com/diasurgical/scalpel">diasurgical/scalpel</a> repository includes a copy of a symbolic file that was accidentally left on the Japanese release of Diablo on Playstation 1. The CD contained debug information in a .SYM file, the format of which has been reversed, so we can recover type information, variable names, etc, for the PSX release.</p>
<ul>
<li>Download and open <a href="https://raw.githubusercontent.com/diasurgical/scalpel/master/psx/symbols/jap_05291998.out">jap_05291998.out</a></li>
<li>Example: search for <code>LoadL1Dungeon__FPcii</code><ul>
<li>Starting memory address <code>0x8013CF64</code></li>
<li>Function name <code>LoadL1Dungeon</code></li>
<li>Function arguments <code>(*char sFilename, int vx, int, vy)</code></li>
<li>#TODO what else can be inferred from below?</li>
</ul>
</li>
</ul>
<div class="fragment"><div class="line">135ea8: $8013cf64 8c Function_start</div>
<div class="line">    fp = 29</div>
<div class="line">    fsize = 48</div>
<div class="line">    retreg = 31</div>
<div class="line">    mask = $80070000</div>
<div class="line">    maskoffs = -4</div>
<div class="line">    line = 905</div>
<div class="line">    file = C:\diabpsx\SOURCE\DRLG_L1.CPP</div>
<div class="line">    name = LoadL1Dungeon__FPcii</div>
<div class="line">135ef4: $00000010 94 Def class REGPARM type PTR CHAR size 0 name sFileName</div>
<div class="line">135f0b: $00000011 94 Def class REGPARM type INT size 0 name vx</div>
<div class="line">135f1b: $00000012 94 Def class REGPARM type INT size 0 name vy</div>
<div class="line">135f2b: $8013cf64 90 Block_start  line = 1</div>
<div class="line">135f34: $00000005 94 Def class REG type INT size 0 name i</div>
<div class="line">135f43: $00000007 94 Def class REG type INT size 0 name j</div>
<div class="line">135f52: $0000000b 94 Def class REG type INT size 0 name rw</div>
<div class="line">135f62: $0000000c 94 Def class REG type INT size 0 name rh</div>
<div class="line">135f72: $00000010 94 Def class REG type PTR UCHAR size 0 name pLevelMap</div>
<div class="line">135f89: $00000008 94 Def class REG type PTR UCHAR size 0 name lm</div>
<div class="line">135f99: $8013d0c4 90 Block_start  line = 44</div>
<div class="line">135fa2: $8013d11c 92 Block_end  line = 60</div>
<div class="line">135fab: $8013d11c 92 Block_end  line = 60</div>
<div class="line">135fb4: $8013d138 8e Function_end</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md125"></a>
Comparing a function with the original exe</h1>
<h2><a class="anchor" id="autotoc_md126"></a>
Using Riivaaja</h2>
<ul>
<li>Step 1: <a href="https://docs.docker.com/install/">https://docs.docker.com/install/</a></li>
<li>Step 2: Download latest devilution-comparer: <a href="https://github.com/diasurgical/devilution-comparer/releases">https://github.com/diasurgical/devilution-comparer/releases</a> (build from src if on Mac)</li>
<li>Step 3: Get the Diablo 1.09 exe</li>
<li>Step 4: If not on Windows Devilution-comparer requires Wine, either install Wine or use Riivaaja as a proxy (more on this later if you would like to go this route).</li>
<li>Step 5:</li>
</ul>
<h3><a class="anchor" id="autotoc_md127"></a>
To get a function for comparison</h3>
<p>Build: <code>docker run --rm -v :/root/devilution -e MAKE_BUILD=pdb diasurgical/riivaaja</code> Generate diff: <code>devilution-comparer Diablo_original.exe Diablo.exe &lt;function_name&gt;</code> You can add <code>--no-mem-disp</code> if you want a cleaner output but this can also hide valuable details This will generate an <code>orig.asm</code> and <code>compare.asm</code> that you can compare in your favorit <code>diff</code> application, in the folder that you can the command from.</p>
<p>To use Riivaaja instead of installing Wine, create <code>wine</code> in your <code>$PATH</code> and add this content:</p>
<div class="fragment"><div class="line">#!/bin/sh</div>
<div class="line">docker run --rm -v $(pwd):/root/devilution --entrypoint &quot;/usr/bin/wine&quot; diasurgical/riivaaja:stable $(basename $1) $2 $3</div>
</div><!-- fragment --><p>(Don't forget to also set exec permissions on the file)</p>
<h2><a class="anchor" id="autotoc_md128"></a>
Using devilution-comparer with Wine</h2>
<p>Install dependencies:</p><ol type="1">
<li>Install Wine if not on Windows (e.g. <code>sudo pacman -S wine</code>)</li>
<li>Install MS VC+ 5 + SP3 and MS VC+ 6 + SP5 + PP. (for more information see the <a href="https://github.com/diasurgical/devil-nightly#building-with-visual-c-6">building instructions</a> of the readme)</li>
</ol>
<p>Install <code>devililution-comparer</code> from release (or from source below):</p><ol type="1">
<li>Download and extract the latest release from <a href="https://github.com/diasurgical/devilution-comparer/releases">https://github.com/diasurgical/devilution-comparer/releases</a></li>
</ol>
<p>Or install <code>devililution-comparer</code> from source:</p><ol type="1">
<li><code>git clone <a href="https://github.com/diasurgical/devililution-comparer">https://github.com/diasurgical/devililution-comparer</a></code></li>
<li><code>cd devililution-comparer</code></li>
<li><code>cargo build --release</code></li>
<li><code>cp cvdump.exe target/release/</code></li>
<li><code>cp comparer-config.toml target/release/</code></li>
</ol>
<p>Clone Devilution nightly, build and compare against the original Diablo binary:</p><ol type="1">
<li><code>git clone <a href="https://github.com/diasurgical/devil-nightly">https://github.com/diasurgical/devil-nightly</a></code></li>
<li><code>make MAKE_BUILD=pdb -f MakefileVC</code></li>
<li><code>cp /path/to/diablo-v1.09b.exe .</code></li>
<li><code>../devilution-comparer/target/debug/devilution-comparer diablo-v1.09b.exe Diablo.exe &lt;function name&gt;</code> (replace <code>&lt;function name&gt;</code> with e.g. <code>InitMonsterTRN</code>)</li>
<li><code>code --diff orig.asm compare.asm</code> (or <code>diff -u orig.asm compare.asm</code>)</li>
</ol>
<p>To watch build directory for changes use the <code>-w</code> command line flag:</p>
<div class="fragment"><div class="line">$ ./devilution-comparer -w diablo-v1.09b.exe Diablo.exe InitMonsterTRN</div>
<div class="line">Found InitMonsterTRN at 0x4322EC, size: 0x8C; orig size: 0x8C</div>
<div class="line">Started watching Diablo.pdb for changes. CTRL+C to quit.</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
